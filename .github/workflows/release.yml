name: Release
on: [push]

jobs:
  build-and-release:
    runs-on: macos-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: Install Node.js
          uses: actions/setup-node@v3
          with:
              node-version: 16

        - uses: pnpm/action-setup@v2
          name: Install pnpm
          id: pnpm-install
          with:
            version: 7.20.0
            run_install: true

        - name: Build React Page
          run: pnpm build

        - name: Package App
          run: pnpm package
        
        - name: Copy App to Workspace
          run: cp -r out/*/Cheese.app /github/workspace/


        - name: Get changes since last release
          id: changes
          uses: simbo/changes-since-last-release-action@v1

        - name: Release App
          if: "contains(github.event.head_commit.message, '[Release] ')"
          run: |
            title=$(echo "${{ github.event.head_commit.message }}" | sed 's/\[Release\] //g')
            gh release create date +'%Y-%m-%d' /github/workspace/Cheese.app --title "$title" --notes "${{ steps.changes.outputs.log }}"
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
